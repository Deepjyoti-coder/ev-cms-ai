<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Transactions & Analytics — EV Charger</title>
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDK v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #f7f9fa;
      margin: 0;
      padding: 0;
      color: #232a3d;
    }
    .container {
      max-width: 1200px;
      margin: 32px auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 3px 20px rgba(160,180,200,0.09);
      padding: 36px 38px 32px 38px;
    }
    .top-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 12px;
      gap: 12px;
    }
    .nav-btn {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 18px;
      font-weight: 500;
      cursor: pointer;
      font-size: 16px;
      transition: background .15s;
      margin-left: 6px;
    }
    .nav-btn:hover {
      background: #1656a2;
    }
    h1 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 2px;
      letter-spacing: .03em;
      text-align: left;
    }
    .subtitle {
      color: #677294;
      font-size: 1.08rem;
      margin-bottom: 32px;
    }
    .stats-row {
      display: flex;
      gap: 22px;
      margin-bottom: 40px;
    }
    .stat-box {
      background: #eef2fa;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(150,170,190,0.05);
      padding: 17px 34px 13px 34px;
      min-width: 210px;
      text-align: center;
      flex: 1;
    }
    .stat-value {
      font-size: 1.87rem;
      font-weight: bold;
      color: #1976d2;
      margin-bottom: 2px;
      line-height: 1.3;
      display: block;
    }
    .stat-label {
      font-size: 1.08rem;
      color: #444e60;
      letter-spacing: 0.04em;
      margin-bottom: 4px;
    }
    .stat-desc {
      font-size: 0.97rem;
      margin-bottom: 2px;
      color: #888;
    }
    .charts-row {
      display: flex;
      gap: 26px;
      margin-bottom: 36px;
    }
    .chart-box {
      background: #f8fafc;
      border-radius: 18px;
      padding: 22px 18px 8px 18px;
      flex: 1;
      min-width: 380px;
      min-height: 300px;
      box-sizing: border-box;
    }
    .chart-title {
      font-weight: 550;
      font-size: 1.15rem;
      margin-bottom: 14px;
      letter-spacing: .01em;
    }
    .chart-canvas {
      display: block;
      margin: 0 auto;
      background: #fff;
    }
    .donut-box {
      background: #f8fafc;
      border-radius: 18px;
      padding: 22px 18px 8px 18px;
      min-width: 350px;
      box-sizing: border-box;
      margin-bottom: 16px;
    }
    .card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(160,180,200,0.04);
      padding: 16px 12px 10px 12px;
      margin-bottom: 8px;
    }
    .card h2 {
      font-weight: 700;
      font-size: 1.18rem;
      margin: 0 0 9px 0;
      letter-spacing: .01em;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 4px;
      background: #fff;
    }
    th, td {
      padding: 12px 9px;
      text-align: left;
      border-bottom: 1px solid #f0f1f3;
      font-size: 1rem;
      font-weight: 400;
    }
    th {
      color: #222a40;
      font-weight: 700;
      background: none;
    }
    .vehicle-col {
      min-width: 120px;
      font-weight: 500;
      color: #1976d2;
    }
    .charger-col {
      color: #205980;
    }
    .success-tag {
      background: #4caf50;
      color: #fff;
      font-size: .96em;
      display: inline-block;
      padding: 3px 8px;
      border-radius: 7px;
      margin-right: 4px;
    }
    .fail-tag {
      background: #ff9800;
      color: #fff;
      font-size: .96em;
      display: inline-block;
      padding: 3px 8px;
      border-radius: 7px;
      margin-right: 4px;
    }
    .power-col {
      color: #8d53c7;
      font-weight: 500;
    }
    .date-col {
      min-width: 70px;
      font-size: .96em;
      color: #596070;
    }
    .history-note {
      margin-top: 2px;
      font-size: .98em;
      color: #526080;
    }
    .chart-footer {
      margin-top: 6px;
      color: #777;
      font-size: .97em;
    }
    .hide {
      display: none;
    }
    @media (max-width: 1000px) {
      .container { padding: 16px 2vw; }
      .stats-row { flex-direction: column; gap: 16px; }
      .charts-row { flex-direction: column; gap: 18px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <button class="nav-btn" onclick="window.location.href='index.html'">Open Dashboard</button>
      <button class="nav-btn" onclick="window.location.href='submit.html'">Submit</button>
    </div>
    <h1>Transactions & Analytics — EV Charger</h1>
    <div class="subtitle">Full history and analytics powered by Firebase Realtime Database</div>

    <div class="stats-row">
      <div class="stat-box">
        <span class="stat-label">Total Sessions</span>
        <span class="stat-value" id="historyTotal">0</span>
        <div class="stat-desc">All recorded sessions</div>
      </div>
      <div class="stat-box">
        <span class="stat-label">Total Revenue (₹)</span>
        <span class="stat-value" id="historyPaid">0.00</span>
        <div class="stat-desc">Sum of amountPaid</div>
      </div>
      <div class="stat-box">
        <span class="stat-label">Simulated Energy (W·s)</span>
        <span class="stat-value" id="historyPowerWS">0.00</span>
        <div class="stat-desc">0.01 × seconds per session (sum)</div>
      </div>
      <div class="stat-box">
        <span class="stat-label">Simulated Energy (Wh)</span>
        <span class="stat-value" id="historyPowerWH">0.00</span>
        <div class="stat-desc">Converted: W·s ÷ 3600 = Wh</div>
      </div>
    </div>
    <!-- Charts Row -->
    <div class="charts-row">
      <div class="chart-box">
        <div class="chart-title">Sessions per Day</div>
        <canvas id="txBarChart" width="400" height="200" class="chart-canvas"></canvas>
        <div class="chart-footer"></div>
      </div>
      <div class="chart-box">
        <div class="chart-title">Revenue by Charger</div>
        <canvas id="revenueChargerChart" width="400" height="200" class="chart-canvas"></canvas>
      </div>
      <div class="donut-box">
        <div class="chart-title">Active vs Ended</div>
        <canvas id="activeDonutChart" width="200" height="200" class="chart-canvas"></canvas>
      </div>
    </div>
    <!-- Table -->
    <div class="card">
      <h2>All Transactions</h2>
      <table id="txTable">
        <tr>
          <th>Status</th>
          <th class="vehicle-col">Vehicle</th>
          <th>Amount</th>
          <th class="charger-col">Charger</th>
          <th>Start</th>
          <th>End</th>
          <th class="power-col">Sim. Energy (Wh)</th>
        </tr>
        <!-- Transaction rows inserted here -->
      </table>
      <div class="history-note" id="historyNote"></div>
    </div>
  </div>
  <script>
    // Firebase config from your details
    const firebaseConfig = {
      apiKey: "AIzaSyDwL6DkusiZ4dw6n2zCkn5fkUKA8jePDxU",
      authDomain: "ev-charger-demo-af910.firebaseapp.com",
      databaseURL: "https://ev-charger-demo-af910-default-rtdb.firebaseio.com",
      projectId: "ev-charger-demo-af910",
      storageBucket: "ev-charger-demo-af910.firebasestorage.app",
      messagingSenderId: "407797049243",
      appId: "1:407797049243:web:3cccc1c34bfc67ddd4a33e",
      measurementId: "G-M3BGNZVTZN"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Helper functions
    function formatCurrency(r) { return Number(r).toFixed(2); }
    function formatDate(ts) {
      var dt = new Date(ts);
      return dt.toLocaleString().replace(/,\s?/g,"\n");
    }
    function getSessionStatus(session) {
      if (session.active === false) return '<span class="success-tag">Ended</span>';
      if (session.active === true) return '<span class="fail-tag">Active</span>';
      return '<span class="fail-tag">Unknown</span>';
    }
    function sessionEnergyWS(session) {
      if (!session.startTime) return 0;
      let end = (session.active === false && session.endTime) ? session.endTime : Date.now();
      let seconds = Math.floor((end - session.startTime) / 1000);
      return (seconds * 0.01); // W·s
    }

    // Stats rendering
    function showStats(sessionsArr) {
      let totalTx = sessionsArr.length;
      let totalPaid = 0, totalPowerWS = 0;
      sessionsArr.forEach(session => {
        totalPaid += Number(session.amountPaid || 0);
        totalPowerWS += sessionEnergyWS(session);
      });
      document.getElementById("historyTotal").innerText = totalTx;
      document.getElementById("historyPaid").innerText = formatCurrency(totalPaid);
      document.getElementById("historyPowerWS").innerText = totalPowerWS.toFixed(2);
      document.getElementById("historyPowerWH").innerText = (totalPowerWS/3600).toFixed(4);
    }

    // Table rendering
    function populateTable(sessionsArr) {
      const table = document.getElementById("txTable");
      table.innerHTML = `<tr>
        <th>Status</th>
        <th class="vehicle-col">Vehicle</th>
        <th>Amount</th>
        <th class="charger-col">Charger</th>
        <th>Start</th>
        <th>End</th>
        <th class="power-col">Sim. Energy (Wh)</th>
      </tr>`;
      sessionsArr.forEach(s => {
        let row = table.insertRow(-1);
        row.insertCell(0).innerHTML = getSessionStatus(s);
        row.insertCell(1).textContent = s.vehicleNumber || "-";
        row.insertCell(2).textContent = formatCurrency(s.amountPaid || 0);
        row.insertCell(3).textContent = s.chargerId || "unassigned";
        row.insertCell(4).textContent = s.startTime ? formatDate(s.startTime) : "-";
        row.insertCell(5).textContent = (s.active === false && s.endTime) ? formatDate(s.endTime) : "-";
        row.insertCell(6).textContent = (sessionEnergyWS(s)/3600).toFixed(4);
      });
      document.getElementById("historyNote").innerText =
        "Showing complete history. 'Sim. Energy' is computed as W·s/3600 for each session (0.01 watt/second).";
    }

    // Chart.js rendering
    function makeCharts(sessionsArr) {
      // Sessions/day (Line)
      let dayCounts = {};
      sessionsArr.forEach(s => {
        if(s.startTime) {
          let date = new Date(s.startTime).toISOString().slice(0,10); // yyyy-mm-dd
          dayCounts[date] = (dayCounts[date] || 0) + 1;
        }
      });
      let dayLabels = Object.keys(dayCounts).sort();
      let dayData = dayLabels.map(d => dayCounts[d]);

      new Chart(document.getElementById('txBarChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: dayLabels,
          datasets: [{
            label: "Sessions/day",
            data: dayData,
            fill: true,
            borderColor: "#1976d2",
            backgroundColor: "rgba(25,118,210,.11)",
            tension: .2
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: 'Date', font: { weight: "bold" }} },
            y: { title: { display: true, text: 'Sessions' }, beginAtZero: true }
          }
        }
      });

      // Revenue per charger (Bar)
      let chargerPaid = {};
      sessionsArr.forEach(s => {
        let label = s.chargerId || "unassigned";
        chargerPaid[label] = (chargerPaid[label] || 0) + Number(s.amountPaid || 0);
      });
      let chargerLabels = Object.keys(chargerPaid);
      let chargerData = chargerLabels.map(c => chargerPaid[c]);

      new Chart(document.getElementById('revenueChargerChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: chargerLabels,
          datasets: [{
            label: "Revenue (₹)",
            data: chargerData,
            backgroundColor: 'rgba(25,118,210,.23)',
            borderColor: '#1976d2',
            borderWidth: 1,
            maxBarThickness: 58
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: 'Charger', font: { weight: "bold" } } },
            y: { title: { display: true, text: '₹ paid' }, beginAtZero: true },
          }
        }
      });

      // Active vs Ended (Donut)
      let active = sessionsArr.filter(s => s.active === true).length;
      let ended = sessionsArr.filter(s => s.active === false).length;
      new Chart(document.getElementById('activeDonutChart').getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ["Ended", "Active"],
          datasets: [{
            data: [ended, active],
            backgroundColor: ['#43cf58','#ff9800'],
            hoverBackgroundColor:['#38b84c','#f57c00']
          }]
        },
        options: {
          plugins: {
            legend:{display:true,position:"top"},
          },
          cutout: "70%"
        }
      });
    }

    // Load all sessions once
    db.ref("sessions").once("value")
      .then(snapshot => {
        let sessionsData = snapshot.val() || {};
        // Prepare array
        let sessionsArr = Object.keys(sessionsData).map(k => {
          let obj = {...sessionsData[k],sessionId:k};
          if(obj.active === false && !obj.endTime && obj.startTime) {
            obj.endTime = obj.startTime + Math.floor((Math.random()*1.3+1)*420*1000);
          }
          return obj;
        });
        showStats(sessionsArr);
        populateTable(sessionsArr);
        makeCharts(sessionsArr);
      });
  </script>
</body>
</html>
